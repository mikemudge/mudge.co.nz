var eighti={},EightI={CACHE_MEMORY_LIMIT:0},Module={doNotCaptureKeyboard:!0,preRun:function(){EightI.CACHE_MEMORY_LIMIT=EightI.Helpers.calculateMemoryLimit(512)},postRun:function(){EightI.Env.initialise()},locateFile:function(a){return EightI.Env.getFileURL(a)},TOTAL_MEMORY:134217728};eighti.audio={};EightI.Audio=function(a){this.url=a;this.initialised=!1;this.totalLength=0;this.source=this.buffer=this.context=null;this.formats=[".ogg",".wav"];this.testedFormats=[];this.loadFailed=null};
EightI.Audio.prototype.createContext=function(){if(null==this.context)if(EightI.Audio.audioContext)this.context=EightI.Audio.audioContext,this.gain=EightI.Audio.gain;else{try{this.context=new AudioContext}catch(a){console.warn(a);try{this.context=new webkitAudioContext}catch(b){console.warn(b)}}this.gain=this.context.createGain();EightI.Audio.audioContext=this.context;EightI.Audio.gain=this.gain}};
EightI.Audio.prototype.load=function(a){this.createContext();var b=new XMLHttpRequest;b.open("GET",this.url,!0);b.responseType="arraybuffer";b.onload=function(){200==b.status?this.decode(b.response,a):this.retryLoad(a)}.bind(this);b.onerror=function(){this.retryLoad(a)}.bind(this);b.send(null)};
EightI.Audio.prototype.retryLoad=function(a){var b,c,d=null;for(b=0;b<this.formats.length;++b)-1!=this.url.indexOf(this.formats[b])&&(this.testedFormats.push(this.formats[b]),d=this.formats[b]);var e=null;for(b=0;b<this.formats.length;++b){var f=!1;for(c=0;c<this.testedFormats.length;++c)if(this.formats[b]==this.testedFormats[c]){f=!0;break}f||(e=this.formats[b])}e&&d?(this.url=this.url.replace(d,e),this.load(a)):this.loadFailed?this.loadFailed():console.warn("audio loading failed",this.url)};
EightI.Audio.prototype.decode=function(a,b){this.context.decodeAudioData(a,function(a){this.buffer=a;this.initialised=!0;this.totalLength=this.buffer.duration;b&&b.apply()}.bind(this),function(a){this.retryLoad(b)}.bind(this))};EightI.Audio.prototype.setVolume=function(a){this.gain&&(this.gain.gain.value=2*a-1)};
EightI.Audio.prototype.play=function(a){this.buffer&&(this.source&&this.source.stop(),this.source=this.context.createBufferSource(),this.source.buffer=this.buffer,this.source.connect(this.context.destination),this.source.connect(this.gain),this.gain.connect(this.context.destination),this.source.start(0,a))};EightI.Audio.prototype.pause=function(){this.buffer&&this.source&&(this.source.stop(),this.source=null)};EightI.Audio.prototype.seek=function(a){this.source&&this.play(a)};
EightI.Audio.prototype.update=function(){};eighti.asset={};EightI.Asset=function(a,b,c){this.handle=this.create_(a,b,c);this.looping=this.playingAudio=this.playing=!1;this.audio=null};
EightI.Asset.prototype={constructor:EightI.Asset,destroy:function(){this.delete_(this.handle);this.handle=null},isValid:function(){return this.handle&&this.isValid_(this.handle)},setRenderMethod:function(a){this.setRenderMethodType_(this.getHandle(),a)},setTargetBufferDuration:function(a){return this.setTargetBufferDuration(this.getHandle(),a)},getTargetBufferDuration:function(){return this.getTargetBufferDuration_(this.getHandle())},getActualBufferDuration:function(){return this.getActualBufferDuration_(this.getHandle())},
getPartialBufferDuration:function(){return this.getPartialBufferDuration_(this.getHandle())},getBufferEndPoint:function(){return this.getBufferEndPoint_(this.getHandle())},play:function(){this.play_(this.getHandle());this.audio&&!this.audioMuted&&this.audio.play(this.getCurrentTime());this.playing=!0},pause:function(){this.pause_(this.getHandle());this.audio&&this.audio.pause();this.playing=!1},seek:function(a){a>=this.getDuration()?this.audio&&this.audio.pause():(this.seek_(this.getHandle(),a),this.audio&&
this.playing&&!this.audioMuted&&this.audio.play(this.getCurrentTime()))},mute:function(a){this.audioMuted=a;this.audio&&(a?this.audio.pause():!a&&this.playing&&this.audio.play(this.getCurrentTime()))},step:function(a){this.step_(this.getHandle(),a)},isPlaying:function(){return this.playing},loop:function(a){this.looping=a},isLooping:function(){return this.looping},getCurrentTime:function(){return this.getCurrentTime_(this.getHandle())},getDuration:function(){return this.getDuration_(this.getHandle())},
loadAudio:function(a){a&&(this.audio=new EightI.Audio(a),this.audio.loadFailed=function(){this.audio=null}.bind(this),this.audio.load())},hasAudio:function(){return null!=this.audio},hasAudioLoaded:function(){return this.hasAudio()?this.audio.initialised:!0},getHandle:function(){return this.handle},create_:void 0,delete_:void 0,isValid_:void 0,setRenderMethodType_:void 0,getMetaCount_:void 0,getMetaEntry_:void 0,getMetaValue_:void 0,setTargetBufferDuration_:void 0,getTargetBufferDuration_:void 0,
getActualBufferDuration_:void 0,getPartialBufferDuration_:void 0,getBufferEndPoint_:void 0,setEnableCache_:void 0,clearCache_:void 0,play_:void 0,pause_:void 0,seek_:void 0,step_:void 0,getCurrentTime_:void 0,getDuration_:void 0,hasAudio_:void 0};
EightI.Asset.libLoaded=function(){EightI.Asset.prototype.create_=Module.cwrap("Asset_Create","number",["string","number","number"]);EightI.Asset.prototype.delete_=Module.cwrap("Asset_Delete",null,["number"]);EightI.Asset.prototype.isValid_=Module.cwrap("Asset_IsValid","number",["number"]);EightI.Asset.prototype.setRenderMethodType_=Module.cwrap("Asset_SetRenderMethodType",null,["number","number"]);EightI.Asset.prototype.getMetaCount_=Module.cwrap("Asset_GetMetaCount","number",["number"]);EightI.Asset.prototype.getMetaEntry_=
Module.cwrap("Asset_GetMetaEntry","number","number number number number number number".split(" "));EightI.Asset.prototype.getMetaValue_=Module.cwrap("Asset_GetMetaValue","number",["number","string","number","number"]);EightI.Asset.prototype.setTargetBufferDuration_=Module.cwrap("Asset_SetTargetBufferDuration",null,["number","number"]);EightI.Asset.prototype.getTargetBufferDuration_=Module.cwrap("Asset_GetTargetBufferDuration","number",["number"]);EightI.Asset.prototype.getActualBufferDuration_=Module.cwrap("Asset_GetActualBufferDuration",
"number",["number"]);EightI.Asset.prototype.getPartialBufferDuration_=Module.cwrap("Asset_GetPartialBufferDuration","number",["number"]);EightI.Asset.prototype.getBufferEndPoint_=Module.cwrap("Asset_GetBufferEndPoint","number",["number"]);EightI.Asset.prototype.setEnableCache_=Module.cwrap("Asset_SetEnableCache",null,["number","number"]);EightI.Asset.prototype.clearCache_=Module.cwrap("Asset_ClearCache",null,["number"]);EightI.Asset.prototype.play_=Module.cwrap("Asset_Play",null,["number"]);EightI.Asset.prototype.pause_=
Module.cwrap("Asset_Pause",null,["number"]);EightI.Asset.prototype.seek_=Module.cwrap("Asset_Seek",null,["number","number"]);EightI.Asset.prototype.step_=Module.cwrap("Asset_Step",null,["number","number"]);EightI.Asset.prototype.getCurrentTime_=Module.cwrap("Asset_GetCurrentTime","number",["number"]);EightI.Asset.prototype.getDuration_=Module.cwrap("Asset_GetDuration","number",["number"]);EightI.Asset.prototype.hasAudio_=Module.cwrap("Asset_HasAudio","number",["number"])};eighti.actor={};EightI.Actor=function(){this.handle=this.create_();this.asset=null};
EightI.Actor.prototype={constructor:EightI.Actor,destroy:function(){this.asset&&(this.asset.destroy(),this.asset=null);this.delete_(this.getHandle());this.handle=null},isValid:function(){return this.handle&&this.isValid_(this.handle)},setAsset:function(a){this.asset=a;this.setAsset_(this.getHandle(),a.getHandle())},setTransform:function(a){this.setTransform_(this.getHandle(),new Int8Array(a.elements.buffer))},setVisible:function(a){this.setVisible_(this.getHandle(),a)},getBounds:function(){var a=
new Float32Array(3),b=new Float32Array(3),c=Module._malloc(12),d=Module._malloc(12),e=Module._malloc(4),f=Module._malloc(4);HEAPF32.set(a,c/4);HEAPF32.set(b,d/4);setValue(e,c,"*");setValue(f,d,"*");this.getBounds_(this.getHandle(),e,f);var g=HEAPF32.subarray(c/4,c/4+3),h=HEAPF32.subarray(d/4,d/4+3);a[0]=g[0];a[1]=g[1];a[2]=g[2];b[0]=h[0];b[1]=h[1];b[2]=h[2];Module._free(c);Module._free(d);Module._free(e);Module._free(f);b[0]*=.5;b[1]*=.5;b[2]*=.5;return{center:a,size:b}},getAABB:function(){var a=
new Float32Array(3),b=new Float32Array(3),c=Module._malloc(12),d=Module._malloc(12),e=Module._malloc(4),f=Module._malloc(4);HEAPF32.set(a,c/4);HEAPF32.set(b,d/4);setValue(e,c,"*");setValue(f,d,"*");this.setAABB_(this.getHandle(),e,f);var g=HEAPF32.subarray(c/4,c/4+3),h=HEAPF32.subarray(d/4,d/4+3);a[0]=g[0];a[1]=g[1];a[2]=g[2];b[0]=h[0];b[1]=h[1];b[2]=h[2];Module._free(c);Module._free(d);Module._free(e);Module._free(f);b[0]*=.5;b[1]*=.5;b[2]*=.5;return{center:a,size:b}},isVisible:function(){return this.isVisible_(this.getHandle())},
calculateDuration:function(){var a=0;this.asset&&(a=this.asset.getDuration());return a},getBufferDuration:function(){return this.asset?this.asset.getBufferDuration():0},getHandle:function(){return this.handle},create_:void 0,delete_:void 0,isValid_:void 0,setAsset_:void 0,setRenderMethod_:void 0,setTransform_:void 0,setVisible_:void 0,getBounds_:void 0,setAABB_:void 0,isVisible_:void 0};
EightI.Actor.libLoaded=function(){EightI.Actor.prototype.create_=Module.cwrap("Actor_Create","number",null);EightI.Actor.prototype.delete_=Module.cwrap("Actor_Delete",null,["number"]);EightI.Actor.prototype.isValid_=Module.cwrap("Actor_IsValid","number",["number"]);EightI.Actor.prototype.setAsset_=Module.cwrap("Actor_SetAsset",null,["number","number"]);EightI.Actor.prototype.setTransform_=Module.cwrap("Actor_SetTransform",null,["number","array"]);EightI.Actor.prototype.setVisible_=Module.cwrap("Actor_SetVisible",
null,["number","number"]);EightI.Actor.prototype.getBounds_=Module.cwrap("Actor_GetBounds",null,["number","number","number"]);EightI.Actor.prototype.setAABB_=Module.cwrap("Actor_GetAABB",null,["number","number","number"]);EightI.Actor.prototype.isVisible_=Module.cwrap("Actor_IsVisible","number",["number"])};eighti.env={};EightI.GlobalManager=function(){this.is_initialised=!1;this.players=[];this.files=[]};
EightI.GlobalManager.prototype={constructor:EightI.GlobalManager,initialise:function(){if(!this.is_initialised){this.initialiseTypes();this.is_initialised=!0;for(var a=0;a<this.players.length;++a)this.initialisePlayer(this.players[a])}},initialiseTypes:function(){EightI.System.libLoaded();EightI.Actor.libLoaded();EightI.FrameBuffer.libLoaded();EightI.Scene.libLoaded();EightI.Asset.libLoaded();EightI.Viewport.libLoaded()},initialisePlayer:function(a){if(!a.is_initialised&&a.gl_context){console.log("initialising player");
a.gl_handle=GL.registerContext(a.gl_context,{majorVersion:1});GL.makeContextCurrent(a.gl_handle);var b=new EightI.System;b.initialise();a.system=b;a.onReady()}},registerPlayer:function(a){this.players.push(a);this.is_initialised&&this.initialisePlayer(a)},unregisterPlayer:function(a){a=this.players.indexOf(a);0<=a&&this.players.splice(a,1)},registerFileURL:function(a,b){this.files[a]=b},getFileURL:function(a){if(a in this.files)return this.files[a];throw"EightI Env url not registered for "+a;}};
EightI.Env=new EightI.GlobalManager;eighti.framebuffer={};EightI.FrameBuffer=function(a){this.handle=0;"object"in a?this.handle=this.createFromObject_(a.object):"colourTexture"in a&&"depthTexture"in a&&(this.handle=this.create_(),this.isValid()&&this.setTextures_(a.colourTexture,a.depthTexture))};
EightI.FrameBuffer.prototype={constructor:EightI.FrameBuffer,destroy:function(){this.delete_(this.handle);this.handle=null},isValid:function(){return this.handle&&this.isValid_(this.handle)},setSize:function(a){this.setSize_(this.getHandle(),new Int8Array((new Float32Array([a.x,a.y])).buffer))},getHandle:function(){return this.handle},create_:void 0,createFromObject_:void 0,delete_:void 0,isValid_:void 0,setTextures_:void 0,setSize_:void 0};
EightI.FrameBuffer.libLoaded=function(){EightI.FrameBuffer.prototype.create_=Module.cwrap("FrameBuffer_Create","number",null);EightI.FrameBuffer.prototype.createFromObject_=Module.cwrap("FrameBuffer_CreateFromObject","number",["number"]);EightI.FrameBuffer.prototype.delete_=Module.cwrap("FrameBuffer_Delete",null,["number"]);EightI.FrameBuffer.prototype.isValid_=Module.cwrap("FrameBuffer_IsValid","number",["number"]);EightI.FrameBuffer.prototype.setTextures_=Module.cwrap("FrameBuffer_SetTextures",
"number",["number","number"]);EightI.FrameBuffer.prototype.setSize_=Module.cwrap("FrameBuffer_SetSize",null,["number","array"])};eighti.helpers={};EightI._Helpers=function(){this.SECOND=1;this.MINUTE=60*this.SECOND;this.HOUR=60*this.MINUTE;this.MEMORY_LIMIT_KEY="MEMORY_LIMIT";this.SIZE_OF_MB=1048576;this.MEMORY_TEST_SIZE=16*this.SIZE_OF_MB};
EightI._Helpers.prototype={constructor:EightI.Helpers,getCookie:function(a){a+="=";for(var b=document.cookie.split(";"),c=0;c<b.length;c++){for(var d=b[c];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null},setCookie:function(a,b){var c=new Date;c.setFullYear(c.getFullYear()+1);document.cookie=a+"="+b+";expires="+c.toGMTString()+";domain=.8i.com;path=/"},timeToString:function(a){var b=Math.floor(a/this.HOUR),c=Math.floor((a-b*this.HOUR)/
this.MINUTE);a=Math.floor(a-b*this.HOUR-c*this.MINUTE);10>a&&(a="0"+a);return 0<b?b+":"+c+":"+a:c+":"+a},calculateMemoryLimit:function(a){var b=this.getCookie(this.MEMORY_LIMIT_KEY);if(b)b=parseInt(b);else{var b=0,c=[],d=null,e=!1;for(a*=this.SIZE_OF_MB;b<a&&!e;){d=null;try{d=new ArrayBuffer(this.MEMORY_TEST_SIZE),b+=this.MEMORY_TEST_SIZE,c.push(d),this.setCookie(this.MEMORY_LIMIT_KEY,b)}catch(f){e=!0}}}console.log("Memory Limit: "+b);return b},matrixEqual:function(a,b){for(var c=0;16>c;++c)if(a.elements[c]!=
b.elements[c])return!1;return!0}};EightI.Helpers=new EightI._Helpers;eighti.scene={};EightI.Scene=function(){this.handle=this.create_();this.actors=[]};
EightI.Scene.prototype={constructor:EightI.Scene,destroy:function(){for(var a=this.actors.length,b=0;b<a;++b)this.actors[b].destroy();this.actors=[];this.delete_(this.handle);this.handle=null},isValid:function(){return this.handle&&this.isValid_(this.handle)},attachActor:function(a){this.attachActor_(this.getHandle(),a.getHandle());this.actors.push(a)},detachActor:function(a){this.detachActor_(this.getHandle(),a.getHandle());a=this.actors.indexOf(a);0<=a&&this.actors.splice(a,1)},calculateDuration:function(){for(var a=
0,b=this.actors.length,c=0;c<b;++c){var d=this.actors[c].calculateDuration();d>a&&(a=d)}return a},getBufferDuration:function(){for(var a=Number.MAX_VALUE,b=this.actors.length,c=0;c<b;++c){var d=this.actors[c].getBufferDuration();d<a&&(a=d)}return a},getHandle:function(){return this.handle},create_:void 0,delete_:void 0,isValid_:void 0,attachActor_:void 0,detachActor_:void 0,containsActor_:void 0};
EightI.Scene.libLoaded=function(){EightI.Scene.prototype.create_=Module.cwrap("Scene_Create","number",null);EightI.Scene.prototype.delete_=Module.cwrap("Scene_Delete",null,["number"]);EightI.Scene.prototype.isValid_=Module.cwrap("Scene_IsValid","number",["number"]);EightI.Scene.prototype.attachActor_=Module.cwrap("Scene_AttachActor",null,["number","number"]);EightI.Scene.prototype.detachActor_=Module.cwrap("Scene_DetachActor",null,["number","number"]);EightI.Scene.prototype.containsActor_=Module.cwrap("Scene_ContainsActor",
"number",["number","number"])};eighti.system={};EightI.System=function(){this.is_initialised=!1};
EightI.System.prototype={constructor:EightI.System,initialise:function(){this.is_initialised||(this.is_initialised=this.initialise_(2,0));return this.is_initialised},garbageCollect:function(){this.garbageCollect_()},update:function(a){this.update_(a)},prepareRender:function(a){this.prepareRender_(a.getHandle())},render:function(a,b){this.render_(a.getHandle(),b.getHandle())},initialise_:void 0,garbageCollect_:void 0,update_:void 0,prepareRender_:void 0,render_:void 0};
EightI.System.libLoaded=function(){EightI.System.prototype.initialise_=Module.cwrap("Player_Initialise","number",["number","number"]);EightI.System.prototype.garbageCollect_=Module.cwrap("Player_GarbageCollect",null,null);EightI.System.prototype.update_=Module.cwrap("Player_Update",null,["number"]);EightI.System.prototype.prepareRender_=Module.cwrap("Player_PrepareRender",null,["number"]);EightI.System.prototype.render_=Module.cwrap("Player_Render",null,["number","number"])};eighti.viewport={};EightI.Viewport=function(){this.handle=this.create_();this.frameBuffer=null;this.currentView=new THREE.Matrix4;this.currentView.makeScale(-2,-2,-2);this.currentProj=new THREE.Matrix4;this.currentProj.makeScale(-2,-2,-2);this.currentNear=this.currentFar=-1;this.currentDim=new THREE.Vector4(-1,-1,-1,-1)};
EightI.Viewport.prototype={constructor:EightI.Viewport,destroy:function(){this.delete_(this.handle);this.handle=null},isValid:function(){return this.handle&&this.isValid_(this.handle)},setViewMatrix:function(a){return EightI.Helpers.matrixEqual(a,this.currentView)?!1:(this.setViewMatrix_(this.getHandle(),new Int8Array(a.elements.buffer)),this.currentView.copy(a),!0)},setProjMatrix:function(a){return EightI.Helpers.matrixEqual(a,this.currentProj)?!1:(this.setProjMatrix_(this.getHandle(),new Int8Array(a.elements.buffer)),
this.currentProj.copy(a),!0)},setNearFarPlane:function(a,b){return this.currentNear!=a||this.currentFar!=b?(this.setNearFarPlane_(this.getHandle(),a,b),this.currentNear=a,this.currentFar=b,!0):!1},setDimensions:function(a,b,c,d){return this.currentDim.x!=a||this.currentDim.y!=b||this.currentDim.z!=c||this.currentDim.w!=d?(this.setDimensions_(this.getHandle(),a,b,c,d),this.currentDim.set(a,b,c,d),!0):!1},setFrameBuffer:function(a){this.frameBuffer=a;this.setFrameBuffer_(this.getHandle(),a.getHandle())},
getHandle:function(){return this.handle},create_:void 0,delete_:void 0,isValid_:void 0,setViewMatrix_:void 0,setProjMatrix_:void 0,setNearFarPlane_:void 0,setDimensions_:void 0,setFrameBuffer_:void 0};
EightI.Viewport.libLoaded=function(){EightI.Viewport.prototype.create_=Module.cwrap("Viewport_Create","number",null);EightI.Viewport.prototype.delete_=Module.cwrap("Viewport_Delete",null,["number"]);EightI.Viewport.prototype.isValid_=Module.cwrap("Viewport_IsValid","number",["number"]);EightI.Viewport.prototype.setViewMatrix_=Module.cwrap("Viewport_SetViewMatrix",null,["number","array"]);EightI.Viewport.prototype.setProjMatrix_=Module.cwrap("Viewport_SetProjMatrix",null,["number","array"]);EightI.Viewport.prototype.setNearFarPlane_=
Module.cwrap("Viewport_SetNearFarPlane",null,["number","number","number"]);EightI.Viewport.prototype.setDimensions_=Module.cwrap("Viewport_SetDimensions",null,["number","number","number","number","number"]);EightI.Viewport.prototype.setFrameBuffer_=Module.cwrap("Viewport_SetFrameBuffer",null,["number","number"])};eighti.player={};EightI.Player=function(a,b){this.system=this.scene=null;this.canvas=a;this.gl_context=b;this.gl_handle=null;this.viewports=[];EightI.Env.registerPlayer(this)};
EightI.Player.prototype={constructor:EightI.Player,onReady:function(){},addViewport:function(a){this.viewports.push(a)},removeViewport:function(a){a=this.viewports.indexOf(a);0<=a&&this.viewports.splice(a,1)},setScene:function(a){this.scene=a},garbageCollect:function(){this.system&&this.system.garbageCollect()},update:function(a){this.system&&this.system.update(a)},prepareRender:function(){this.system&&this.scene&&this.system.prepareRender(this.scene)},render:function(){if(this.system&&this.scene)for(var a=
this.viewports.length,b=0;b<a;++b)this.system.render(this.scene,this.viewports[b])}};
